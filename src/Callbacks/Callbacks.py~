import tensorflow                         as tf
from tensorflow                           import keras
import tensorflow.keras.callbacks         as CB
from tensorflow.python.util.tf_export     import keras_export

@keras_export('keras.callbacks.ReduceLROnPlateau')
class ReduceLROnPlateau(CB.ReduceLROnPlateau):
    
  def __init__(self,
               monitor='val_loss',
               factor=0.1,
               patience=10,
               verbose=0,
               mode='auto',
               min_delta=1e-4,
               cooldown=0,
               min_lr=0,
               **kwargs):

    super(ReduceLROnPlateau, self).__init__(monitor=monitor, factor=factor, patience=patience, verbose=verbose,                                                                                                               mode=mode, min_delta=min_delta, cooldown=cooldown, min_lr=min_lr, **kwargs)


    def on_epoch_end(self, epoch, logs=None):
      logs = logs or {}
      logs['lr'] = K.get_value(self.model.optimizer._decayed_lr(tf.float64))
      current = logs.get(self.monitor)
      if current is None:
        logging.warning('Learning rate reduction is conditioned on metric `%s` '
                        'which is not available. Available metrics are: %s',
                        self.monitor, ','.join(list(logs.keys())))
        
      else:
        if self.in_cooldown():
          self.cooldown_counter -= 1
          self.wait = 0
          
          if self.monitor_op(current, self.best):
            self.best = current
            self.wait = 0
          elif not self.in_cooldown():
            self.wait += 1
            if self.wait >= self.patience:
              old_lr = K.get_value(self.model.optimizer._decayed_lr(tf.float64))
              if old_lr > self.min_lr:
                new_lr = old_lr * self.factor
                new_lr = max(new_lr, self.min_lr)
                K.set_value(self.model.optimizer._decayed_lr(tf.float64), new_lr)
                if self.verbose > 0:
                  print('\nEpoch %05d: ReduceLROnPlateau reducing learning '
                        'rate to %s.' % (epoch + 1, new_lr))
                  self.cooldown_counter = self.cooldown
                  self.wait = 0
                  
